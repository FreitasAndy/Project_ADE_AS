---
title: "ADEs and Agricolae Soils"
author: "Anderson Freitas"
date: "Jul/14/2022"
output: html_notebook
---

How we made our analysis and figures:

## Dirty work
Here we will put all the libraries we needed for downstream analysis. I will use it to simplify and unify all libraries in one only chunk.

```{r message=FALSE}

#Libraries

library(hues)
library(knitr)
library(readr)
library(vegan)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(magrittr)
library(microeco)
library(corrplot)
library(phyloseq)
library(agricolae)
library(tidyverse)
library(microbiome)
library(factoextra)

#############################################

summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  library(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Rename the "mean" column    
  datac <- plyr::rename(datac, c("mean" = measurevar))
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}

#############################################

```

## Setting some questions of beauty

```{r}

theme_set(theme_bw())
pal = "Set1"
scale_colour_discrete <-  function(palname=pal, ...){
  scale_colour_brewer(palette=palname, ...)
}
scale_fill_discrete <-  function(palname=pal, ...){
  scale_fill_brewer(palette=palname, ...)
}

ze=c("#79b643", "#bb59bd", "#52ac7a", "#cf426b", "#4dadcf","#cf5234",
     "#7475cb", "#cea13d", "#be6c91", "#748037", "#be774e")

```

## Starting with non-genomic data

At a first moment, we will add only the mapping file to proceed to initial ande descriptive analysis of the data.

```{r}

map_tpsa <- read_delim("map_tpsa.csv", delim = "\t",
                       escape_double = FALSE, na = "NA", trim_ws = TRUE)
map = data.frame(map_tpsa)

```


## Importing files from dada2 and creating a phyloseq object

```{r}

seqtab = readRDS("dada2/seqtab_final.rds")
taxa = readRDS("dada2/taxonomy_genera.rds")
mapfile <- "map_tpsa.csv"

map = import_qiime_sample_data(mapfile)

# Building a phyloseq object

ps <- phyloseq(tax_table(taxa), otu_table(seqtab, taxa_are_rows=FALSE))

input = merge_phyloseq(ps,map) 

input

microbiome::summarize_phyloseq(input)

```

## Subsetting and organizing data

```{r}

#Rarefaction
inputR = rarefy_even_depth(input, sample.size = 82270, replace = FALSE)

#Subsetting
Cedrela  = subset_samples(inputR, Tree == "C. fissilis")
Pelto    = subset_samples(inputR, Tree == "P. dubium")
Cecropia = subset_samples(inputR, Tree == "C. pachystachya")
Bulk     = subset_samples(inputR, Tree == "Bulk")

#Creating clr objects
inputR.clr = microbiome::transform(inputR, "clr")

```
##Creating the R6 objects

```{r}

## for Cedrela ##

otu_ced = as.data.frame(t(otu_table(Cedrela)))
tax_ced = as.data.frame(tax_table(Cedrela))
map_ced = data.frame(sample_data(Cedrela))

dataset.ced <- microtable$new(sample_table = map_ced,
                              otu_table    = otu_ced,
                              tax_table    = tax_ced)
dataset.ced$tidy_dataset()
dataset.ced

## for Peltophorum ##

otu_pel = as.data.frame(t(otu_table(Pelto)))
tax_pel = as.data.frame(tax_table(Pelto))
map_pel = data.frame(sample_data(Pelto))

dataset.pel <- microtable$new(sample_table = map_pel,
                              otu_table    = otu_pel,
                              tax_table    = tax_pel)
dataset.pel$tidy_dataset()
dataset.pel

## for Cecropia ##

otu_cec = as.data.frame(t(otu_table(Cecropia)))
tax_cec = as.data.frame(tax_table(Cecropia))
map_cec = data.frame(sample_data(Cecropia))

dataset.cec <- microtable$new(sample_table = map_cec,
                              otu_table    = otu_cec,
                              tax_table    = tax_cec)
dataset.cec$tidy_dataset()
dataset.cec

## for bulk ##

otu_bk = as.data.frame(t(otu_table(Bulk)))
tax_bk = as.data.frame(tax_table(Bulk))
map_bk = data.frame(sample_data(Bulk))

dataset.bk <- microtable$new(sample_table  = map_bk,
                              otu_table    = otu_bk,
                              tax_table    = tax_bk)
dataset.bk$tidy_dataset()
dataset.bk

## for the whole dataset ##

otu_tp = as.data.frame(t(otu_table(inputR)))
tax_tp = as.data.frame(tax_table(inputR))
map_tp = data.frame(sample_data(inputR))

# Let's create a microtable object with more information
dataset <- microtable$new(sample_table = map_tp,
                          otu_table    = otu_tp,
                          tax_table    = tax_tp)
dataset

dataset$tax_table %<>% tidy_taxonomy

```

## FIGURE: Alpha Diversity

```{r}

#Calculating Alpha Diversity
observed=microbiome::alpha(inputR, index = "all")
meta=microbiome::meta(inputR)

#Creating a file to plot a graph
alpha= cbind(observed,meta)

#Testing differences
dunn.test::dunn.test(alpha$observed, alpha$Treatment,
                     method="bh", kw=TRUE, label=TRUE,
                     wrap=FALSE, table=F, list=T, rmc=FALSE, 
                     alpha=0.05, altp=FALSE)

alpha$Substrate <- factor(alpha$Substrate, levels = c("Control", "20%ADE", "ADE"))
alpha$Tree <- factor(alpha$Tree, levels = c("Bulk", "C. pachystachya",
                                            "P. dubium", "C. fissilis"))

alpha.plot = 
  ggplot(data = alpha, aes(x=Tree, y=observed, fill = Substrate)) +
  geom_boxplot() +
  labs(x = "Tree", y= "Number of Taxa") +
  theme(axis.text.x = element_text(angle = -15, vjust = 0.5, hjust=0.5)) +
  labs(color='Treatment') + guides(color = "none")+
  scale_fill_manual(values = c("#cb6751", "#9e6ebd", "#7aa457"))
  
alpha.plot

#Don't forget setwd
#dev.print(tiff, "./Figures/alpha_div.tiff", compression = "lzw", res=600, height=5, width=8, units="in")

```


## FIGURE: Beta Diversity

```{r}

#Firstly, a perMANOVA

df        = as(sample_data(inputR.clr), "data.frame")
ds        = phyloseq::distance(inputR.clr, method = "euclidean")
permanova = adonis2(ds ~ Tree*Substrate, data = df, permutations = 999)

permanova

#And the plot

input_ord = ordinate(inputR.clr, "PCoA" , "euclidean") 
#p3 = plot_ordination(inputR.clr, input_ord, color = "Tree", shape = "Substrate")
#p1.subs_shape = p3 + geom_point(aes(shape = Substrate), size = 6, alpha = 0.8) +
#  theme(legend.position = "right") +
#  scale_fill_manual(values = ze)

p4 = plot_ordination(inputR.clr, input_ord, color = "Substrate", shape = "Tree")
p1.tree_shape = p4 + geom_point(aes(shape = Tree), size = 6, alpha = 0.8) +
  theme(legend.position = "right") +
  annotate("text", x = -60, y = -48, hjust = 0.2 , 
           label = bquote('Substrate:'~R^2~'= 0.11  |  p = 0.001'), size = 3)+
  annotate("text", x = -60, y = -52, hjust = 0.2 , 
           label = bquote('Tree:'~R^2~'= 0.09  |  p = 0.004'), size = 3)+
  scale_fill_manual(values = ze)


#p1.subs_shape
p1.tree_shape

#dev.print(tiff, "./Figures/Beta_div.tiff", compression = "lzw", res=600, height=5, width=8, units="in")

```

## FIGURE: Distribution of phyla

```{r}

# create trans_abund object
# using 10 Phyla with the highest abundance in the dataset.
dataset$cal_abund()
t1 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", ntaxa = 10)

# two facets example
# require package ggh4x, first run install.packages("ggh4x") if not installed
ov.phyl = t1$plot_bar(others_color = "grey70", facet = "Tree",
            facet2 = "Substrate", xtext_keep = FALSE, legend_text_italic = FALSE, barwidth = 1)
ov.phyl = ov.phyl +
  theme(axis.title.y = element_text(size = 12))

ov.phyl
#dev.print(tiff, "./Figures/Overall_phyla.tiff", compression = "lzw", res=600, height=5, width=8, units="in")

```

#Plotting figures together

```{r}

bc = ggarrange(alpha.plot, p1.tree_shape, 
          labels = c("B.", "C."),
          common.legend = FALSE,
          legend = "right",
          ncol = 2, nrow = 1)
bc

### Arrange plots on one page ###
a = ggarrange(ov.phyl, bc, 
          labels = c("A"),
          common.legend = FALSE,
          legend = "right",
          ncol = 1, nrow = 2)

a
```


## FIGURE: Production aspects

```{r}
#Excluding initial samples
#DM is the object with only T1 samples

DM <- filter(map_tpsa, U_brizantha_weight != "NA")
DM = DM %>%
  arrange(U_brizantha_weight) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
  mutate(Substrate=factor(Substrate, levels=c("Control", "20%ADE", "ADE")))

comparison = list(c("Control", "ADE"), c("Control", "20%ADE"), c("20%ADE", "ADE"))

## Urochloa brizantha ##

DM.plot = ggplot(data = DM, mapping = aes(x = Substrate, y = U_brizantha_weight, fill = Substrate)) +
  geom_boxplot() +
  theme(legend.position = "none") +
  stat_compare_means(comparisons = comparison) +
  labs(title = "U. brizantha production", y = "Dry mass (g)") +
  scale_fill_manual(values = c("#7aa457", "#9e6ebd", "#cb6751"))
DM.plot

#dev.print(tiff, "./Figures/Urochloa.tiff", compression = "lzw", res=600, height=4, width=6, units="in")

```


```{r}

## Plants' dry matter ##
TM.plot = ggplot(data = DM, mapping = aes(x = Substrate, y = Dry_Mass, fill = Treatment)) +
  geom_boxplot() +
  facet_grid(.~Tree, scales="free", space="free_x") +
  theme(legend.position="none") +
  labs(title="Dry matter production",
        x ="", y = "DM production (g)")

## Plant height ##
H.plot = ggplot(data = DM, mapping = aes(x = Substrate, y = Height, fill = Treatment)) +
  geom_boxplot() +
  facet_grid(.~Tree, scales="free", space="free_x") + 
  theme(legend.position="none") +
  labs(title="Plant height",
        x ="", y = "Height (cm)")

## Root size ##
RS.plot = ggplot(data = DM, mapping = aes(x = Substrate, y = Root_size, fill = Treatment)) +
  geom_boxplot() +
  facet_grid(.~Tree, scales="free", space="free_x") + 
  theme(legend.position="none") +
  labs(title="Root size",
        x ="Substrate", y = "Root size (cm)")

#Binding graphics
plants.g = ggarrange(TM.plot, H.plot, RS.plot, ncol=1, nrow = 3, align = "hv", common.legend = F)
plants.g

#dev.print(tiff, "./Figures/Growing.tiff", compression = "lzw", res=600, height=8, width=6, units="in")

```
## FIGURE: Soil Chemistry

#First, testing what is different

```{r}
cec.chem = filter(map_tpsa) 

cec.chem[is.na(cec.chem)] <- 0

my.variables <- cec.chem[c(4,7:9, 11:38)]

for(i in 1:length(my.variables)) {
        aaa = kruskal.test(x = as.matrix(my.variables[,i]), g = cec.chem$Treatment)
        if(aaa$p.value <= 0.05) {
        print(colnames(my.variables[i]))
        print(aaa)
        } else {
          }
}

print("OM")
dunn.test::dunn.test(x = cec.chem$OM, g=cec.chem$Treatment, method = "bh")
print("pH")
dunn.test::dunn.test(x = cec.chem$pH, g=cec.chem$Treatment, method = "bh")
print("P")
dunn.test::dunn.test(x = cec.chem$P, g=cec.chem$Treatment, method = "bh")
print("K")
dunn.test::dunn.test(x = cec.chem$K, g=cec.chem$Treatment, method = "bh")
print("Ca")
dunn.test::dunn.test(x = cec.chem$H, g=cec.chem$Treatment, method = "bh")
print("V%")
dunn.test::dunn.test(x = cec.chem$S.B., g=cec.chem$Treatment, method = "bh")
print("B")
dunn.test::dunn.test(x = cec.chem$BControleSaturation, g=cec.chem$Treatment, method = "bh")
print("S")
dunn.test::dunn.test(x = cec.chem$S, g=cec.chem$Treatment, method = "bh")

print("Cu")
dunn.test::dunn.test(x = cec.chem$Cu, g=cec.chem$Treatment, method = "bh")
print("Fe")
dunn.test::dunn.test(x = cec.chem$Fe, g=cec.chem$Treatment, method = "bh")
print("Mn")
dunn.test::dunn.test(x = cec.chem$Mn, g=cec.chem$Treatment, method = "bh")
print("Zn")
dunn.test::dunn.test(x = cec.chem$Zn, g=cec.chem$Treatment, method = "bh")
print("C")
dunn.test::dunn.test(x = cec.chem$TotalCarbon, g=cec.chem$Treatment, method = "bh")
print("Sand")
dunn.test::dunn.test(x = cec.chem$Sand, g=cec.chem$Treatment, method = "bh")
print("Clay")
dunn.test::dunn.test(x = cec.chem$Clay, g=cec.chem$Treatment, method = "bh")

```
## Mean 

```{r}

map.d = group_by(map_tpsa, Treatment)

print("OM")
map.d %>% summarise(
  média=mean(OM),
  desvio_pad=sd(OM) )

print("pH")
map.d %>% summarise(
  média=mean(pH),
  desvio_pad=sd(pH) )

print("P")
map.d %>% summarise(
  média=mean(P),
  desvio_pad=sd(P) )

print("K")
map.d %>% summarise(
  média=mean(K),
  desvio_pad=sd(K) )

print("Ca")
map.d %>% summarise(
  média=mean(Ca),
  desvio_pad=sd(Ca) )

print("Mg")
map.d %>% summarise(
  média=mean(Mg),
  desvio_pad=sd(Mg) )

print("H")
map.d %>% summarise(
  média=mean(H),
  desvio_pad=sd(H) )

print("V%")
map.d %>% summarise(
  média=mean(BControleSaturation),
  desvio_pad=sd(BControleSaturation) )

print("S")
map.d %>% summarise(
  média=mean(S),
  desvio_pad=sd(S) )

print("*B")
map.d %>% summarise(
  média=mean(`*B`),
  desvio_pad=sd(`*B`) )


```



```{r}

#Cecropia

#t1 <- trans_env$new(dataset = dataset.cec, add_data = map_tp[, c(11:17, 24:27, 35:38)])

#t1$cal_diff(method = "KW_dunn", group = "Substrate")
# place all the plots into a list
##tmp <- list()
#for(i in colnames(t1$data_env)){
#  tmp[[i]] <- t1$plot_diff(measure = i, add_sig_text_size = 5, xtext_size = 12) + theme(plot.margin = unit(c(0.1, 0, 0, 1), "cm"))
#}
#gridExtra::arrangeGrob(grobs = tmp, ncol = 4)

#t1$cal_autocor(group = "Substrate")

#dev.print(tiff, "Chemistry.tiff", compression = "lzw", res=600, height=20, width=20, units="in")

```

## FIGURE: RDA

```{r}

#Analysing

t1 <- trans_env$new(dataset = dataset, add_data = map_tp[, c(11:17, 24, 27, 35:38)])

t1$cal_diff(method = "KW_dunn", group = "Substrate")


t1$cal_ordination(method = "RDA", taxa_level = "Family")
t1$trans_ordination(show_taxa = 10, adjust_arrow_length = TRUE,
                    max_perc_env = 2.5, max_perc_tax = 2.5,
                    min_perc_env = 0.9, min_perc_tax = 0.9)

#Plotting
rda = t1$plot_ordination(plot_color = "Substrate",
                   plot_shape = "Tree", plot_type = c("point", "ellipse"))



#dev.print(tiff, "./Figures/RDA.tiff", compression = "lzw", res=600, height=6, width=8, units="in")

```

## FIGURE: Differential abundance over treatments

```{r}

t1 <- trans_diff$new(dataset = dataset, method = "lefse", group = "Substrate", alpha = 0.01, lefse_subgroup = NULL)
# see t1$res_diff for the result
# From v0.8.0, threshold is used for the LDA score selection.
t1$plot_diff_bar(threshold = 4)
# we show 20 taxa with the highest LDA (log10)
t1$plot_diff_bar(use_number = 1:30, width = 0.8, group_order = c("Control", "20%ADE", "ADE"))

t1$plot_diff_abund(use_number = 1:10, group_order = c("Control", "20%ADE", "ADE"))


# use Genus level for parameter taxa_level, if you want to use all taxa, change to "all"
# nresam = 1 and boots = 1 represent no bootstrapping and use all samples directly
t1 <- trans_diff$new(dataset = dataset, method = "rf", group = "Substrate", taxa_level = "Genus")
# plot the MeanDecreaseGini bar
g1 <- t1$plot_diff_bar(use_number = 1:15, group_order = c("Control", "20%ADE", "ADE"))
# plot the abundance using same taxa in g1
g2 <- t1$plot_diff_abund(group_order = c("Control", "20%ADE", "ADE"), select_taxa = t1$plot_diff_bar_taxa)
# now the y axis in g1 and g2 is same, so we can merge them
# remove g1 legend; remove g2 y axis text and ticks
g1 <- g1 + theme(legend.position = "none", axis.title.x = element_text(size = 12),
                 axis.text.y = element_text(size = 9))
g2 <- g2 + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
                 axis.title.x = element_text(size = 12), axis.title.y = element_blank())
gridExtra::grid.arrange(g1, g2, ncol = 2, nrow = 1, widths = c(2, 1.7))

#dev.print(tiff, "heatmap.tiff", compression = "lzw", res=600, height=6, width=8, units="in")

```

## FIGURE: Functional Predicting


```{r}

dataset <- microtable$new(sample_table = map_tp,
                          otu_table    = otu_tp,
                          tax_table    = tax_tp)
dataset

dataset$tidy_dataset()

t1 <- trans_func$new(dataset)
t1$cal_spe_func(prok_database = "FAPROTAX")
t1$cal_spe_func_perc(abundance_weighted = FALSE)

#Saving the output
genes = cbind(as.data.frame(t1$res_spe_func_perc), map_tp)
write.csv(genes, file = "genes.csv")



```

## FIGURE: Network

```{r}

t1 <- trans_network$new(dataset = dataset, cor_method = "spearman", use_WGCNA_pearson_spearman = TRUE, filter_thres = 0.0001)

t1$cal_sum_links(taxa_level = "Phylum")
# require chorddiag package; see https://github.com/mattflor/chorddiag
t1$plot_sum_links(plot_pos = TRUE, plot_num = 10)


```

